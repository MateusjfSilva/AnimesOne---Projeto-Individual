<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/momentos.css" />
    <link rel="icon" href="Assents/logo.png" />
    <script src="../js/funcoes.js"></script>
    <title>Momentos</title>
  </head>

  <body onload="carregarCards()">
    <div class="l-grid">
      <header class="l-header">
        <img class="merry" src="Assents/merry.png" alt="" />
        <div class="container">
          <img
            src="../Assents/logo_colorida.png"
            alt="logo de One Piece em preto e branco"
          />
          <span>Tales</span>
        </div>
        <nav class="navbar">
          <ul>
            <li onclick="limparSessao()"><a href="login.html">SAIR</a></li>
          </ul>
        </nav>
        <img class="sunny" src="Assents/sunny.png" alt="" />
      </header>

      <aside class="l-aside">
        <h2>Olá, <span id="nickname"></span></h2>
        <div class="titulo_e_frase">
          <h2>Lembraças</h2>
          <span id="frase_usuario"
            >Escreva aqui sua frase favorita do anime</span
          >
        </div>
        <select
          title="seletor de ordem de agrupamento"
          class="slt-ordenar"
          id="select-ordenar"
        >
          <option value="0">Exibir</option>
          <option value="1">Aberturas</option>
          <option value="2">Lembranças</option>
        </select>
      </aside>

      <section>
        <main id="main_cards" class="l-main"></main>

        <div id="formulario" class="formulario-modal">
          <div class="container">
            <img
              onclick="fecharModal()"
              src="Assents/back-icon.png"
              alt="icon para voltar a home page"
            />
            <h2>Avaliar</h2>
            <div class="l-campos">
              <span>Digite a nota:</span>
              <input
                autofocus
                id="ipt_nota"
                type="number"
                pattern="[0-9]"
                placeholder="De 0 a 10"
              />
              <div id="validacao_nota"></div>
            </div>
            <div class="l-campos">
              <select title="videos" id="nota_lembranca">
                <option disabled selected>-- SELECIONE A LEMBRANÇA</option>
                <option value="1">Sanji quer voltar para o Sunny</option>
                <option value="2">Caminhada para Franky house</option>
                <option value="3">Robin - Eu quero viver!</option>
                <option value="4">Jinbe doa seu sangue à Luffy</option>
                <option value="5">Nami pede ajuda a Luffy que...</option>
                <option value="6">Luffy chama Franky para o bando</option>
                <option value="7">Luffy chama Zoro para o bando</option>
                <option value="8">Luffy chama Chopper para o bando</option>
                <option value="9">Bink's Sake</option>
                <option value="10">Usopp sai do bando</option>
                <option value="11">
                  Usopp se pede desculpas e volta para o bando
                </option>
              </select>
              <div id="validacao_email"></div>
            </div>
            <button onclick="publicar(1)" id="btn_cadastro">AVALIAR</button>
            <span id="erro_geral"></span>
          </div>
        </div>
      </section>

      <div class="video-player" id="player_video">
        <video width="100%" autoplay controls id="meuVideo">
          <source src="" type="video/mp4" />
        </video>
        <img
          src="Assents-cards/close-button.png"
          class="close-btn"
          alt="Botão para fechar o video"
          onclick="closeVideo()"
        />
      </div>

      <footer>
        <div class="l-footer">
          <span>Desenvolvido por um aluno SPTech fã de One Piece</span>
          <span>Projeto Individual de Mateus Joaquim ₢</span>
        </div>
      </footer>
    </div>
  </body>
</html>
<!-- script da lista e videos e exibição na tela -->
<script>
  var listaVideos = [
    {
      titulo: "Sanji quer voltar para o Sunny",
      imagem: "Assents-cards/sanji-quer-voltar-para-o-sunny.jpg",
      urlVideo: "Assents/videos/sanji-quer-voltar-para-o-sunny.mp4",
    },
    {
      titulo: "Caminhada para Franky house",
      imagem: "Assents-cards/caminhada-para-franky-house.jpg",
      urlVideo: "Assents/videos/caminhada-para-franky-house.mp4",
    },
    {
      titulo: "Robin - Eu quero viver!",
      imagem: "Assents-cards/robin-quero-viver.jpg",
      urlVideo: "Assents/videos/robin-quero-viver.mp4",
    },
    {
      titulo: "Jinbe doa seu sangue à Luffy",
      imagem: "Assents-cards/jinbe-doa-sangue-para-luffy.jpg",
      urlVideo: "Assents/videos/.mp4",
    },
    {
      titulo: "Nami pede ajuda a Luffy",
      imagem: "Assents-cards/nami-pede-sorroco-a-luffy.jpg",
      urlVideo: "Assents/videos/nami-pede-sorroco-a-luffy.mp4",
    },
    {
      titulo: "Luffy chama Franky para o bando",
      imagem: "Assents-cards/luffy-recruta-franky.jpg",
      urlVideo: "Assents/videos/luffy-recruta-franky.mp4",
    },
    {
      titulo: "Luffy chama Zoro para o bando",
      imagem: "Assents-cards/luffy-recruta-zoro.jpg",
      urlVideo: "Assents/videos/luffy-recruta-zoro.mp4",
    },
    {
      titulo: "Luffy chama Chopper para o bando",
      imagem: "Assents-cards/Luffy-recruta-chopper.jpg",
      urlVideo: "Assents/videos/Luffy-recruta-chopper.mp4",
    },
    {
      titulo: "Bink's Sake",
      imagem: "Assents-cards/binks-sake.jpg",
      urlVideo: "Assents/videos/binks-sake.mp4",
    },
    {
      titulo: "Usopp sai do bando",
      imagem: "Assents-cards/usopp-sai-do-bando.jpg",
      urlVideo: "Assents/videos/usopp-sai-bando.mp4",
    },
    {
      titulo: "Usopp se pede desculpas e volta para o bando",
      imagem: "Assents-cards/usopp-volta-para-o-bando.jpg",
      urlVideo: "Assents/videos/usopp-volta-para-o-bando.mp4",
    },
  ];

  function carregarCards() {
    for (var index = 0; index < listaVideos.length; index++) {
      var video = listaVideos[index];

      main_cards.innerHTML += `
            <div id="card${index}" class="card">
                    <div class="card-img">
                        <img src="${video.imagem}" width="100%" alt="">
                        <img src="Assents-cards/play-img.png" class="play-bnt" alt="Botão de play" onclick="playVideo('${video.urlVideo}')">
                    </div>
                    <div class="text-cards">
                        <span>${video.titulo}</span>
                        <div class="nota"> <span>NOTA MÉDIA: </span><span class="valor-nota"></span></div>
                        <div class="div-avaliar" id="avaliacao_nota">
                            <button onclick="abrirModal()">Avaliar</button>
                        </div>
                    </div>
                </div>
            `;
    }
  }

  console.log(listaVideos);
  // console.log(notas);
</script>

<!-- Modal script  e avaliação-->
<script>
  var videoPlayer = document.getElementById("player_video");
  var video = document.getElementById("meuVideo");

  function closeVideo() {
    videoPlayer.style.display = "none";
    video.pause();
  }

  function playVideo(file) {
    video.src = file;
    videoPlayer.style.display = "block";
  }

  function fecharModal() {
    for (var index = 0; index < listaVideos.length; index++) {
      formulario.style.display = "none";
      document.getElementById("card" + index).style.display = "flex";
    }
  }

  function abrirModal() {
    for (var index = 0; index < listaVideos.length; index++) {
      formulario.style.display = "flex";
      document.getElementById("card" + index).style.display = "none";
    }
  }
  nickname.innerHTML = sessionStorage.NOME_USUARIO;
</script>

<!-- Publicar nota para momento -->
<script>
  function publicar() {
    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var idVar = nota_lembranca.value;
    var select = nota_lembranca;
    var tituloVar = select.options[select.selectedIndex].text;
    var notaVar = ipt_nota.value;
    var idUsuario = sessionStorage.ID_USUARIO;

    if (notaVar == "") {
      alert("campo em branco");
      return false;
    } else {
    }

    // Enviando o valor da nova input
    fetch(`/avaliar/publicar/${idUsuario}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        idServer: idVar,
        notaServer: notaVar,
        tituloServer: tituloVar,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          mensagem_erro.innerHTML = "Avaliação realizada com sucesso!";

          setTimeout(() => {
            window.location = "momentos.html";
          }, "2000");
        } else {
          throw "Houve um erro ao tentar realizar a avaliação!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    return false;
  }

  function atualizarFeed() {
    //aguardar();
    fetch("/avisos/listar")
      .then(function (resposta) {
        if (resposta.ok) {
          if (resposta.status == 204) {
          }

          resposta.json().then(function (resposta) {
            console.log("Dados recebidos: ", JSON.stringify(resposta));
            
            for (var index = 0; index < listaVideos.length; index++) {
                var video = listaVideos[index];
                var publicacao = resposta[index];

              main_cards.innerHTML += `
            <div id="card${index}" class="card">
                    <div class="card-img">
                        <img src="${video.imagem}" width="100%" alt="">
                        <img src="Assents-cards/play-img.png" class="play-bnt" alt="Botão de play" onclick="playVideo('${video.urlVideo}')">
                    </div>
                    <div class="text-cards">
                        <span>${video.titulo}</span>
                        <div class="nota"> <span>NOTA MÉDIA: </span><span class="valor-nota">${publicacao.notaMed}</span></div>
                        <div class="div-avaliar" id="avaliacao_nota">
                            <button onclick="abrirModal()">Avaliar</button>
                        </div>
                    </div>
                </div>
            `;
            }
          });
        } else {
          throw "Houve um erro na API!";
        }
      })
      .catch(function (resposta) {
        console.error(resposta);
      });
  }
</script>
